<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
  <title>Braun Dissertation</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link rel='stylesheet' type='text/css' href='../css/exp1Style.css'>
  <link rel='stylesheet' type='text/css' href='../../globalStyle/globalStyle.css?v=2'>
  <link rel='stylesheet' type='text/css' href='../../globalStyle/deckStyle.css'>
  <script src='../js/exp1Functions.js?v=2'></script>
  <script src='../../globalJs/globalFunctions.js?v=1'></script>
  <script src='../../globalJs/TimTurkTools.js'></script>
  <script src='../../globalJs/jquery-bbq.js'></script>

<script>

// dummy url
// http://davebraun.org/dissertation/experiments/exp1/twoChoice/?workerId=NONE&assignmentId=NONE&taskCueCode%5Bblue%5D=mag&taskCueCode%5Bred%5D=par&experimentStartTime=1553711746626&rtPercentiles%5Bfiftieth%5D=750&rtPercentiles%5BthirtyFifth%5D=719&highRewardPoints=59.621429443359375

$(document).ready(function(){

// GLOBAL VARS
// thresholds
var blockThreshold = 3;
var pointThreshold = 200;

// parse url args
var taskCueCode = urlArgsToVar('taskCueCode')=='NONE'? codeTaskCue() : urlArgsToVar('taskCueCode');
var clientCueCode = cueForClient(taskCueCode);
var experimentStartTime = urlArgsToVar('experimentStartTime');
var phaseStartTime = Date.now();
// THE VALUES COME IN AS STRINGS (for now)
var rtPercentiles = urlArgsToVar('rtPercentiles');
rtPercentiles['fiftieth'] = parseInt(rtPercentiles['fiftieth']);
rtPercentiles['thirtyFifth'] = parseInt(rtPercentiles['thirtyFifth']);
var highRewardPoints = parseInt(urlArgsToVar('highRewardPoints'));

// other global vars
var blockCount = 0;
var trialCount = 0;
var rsi = 500;
var prevTaskColor = '';
var experimentName = 'dissertationExperiment1';
var phase = 'twoChoice';
var rtStartTime = new Date();
var responseCount = 0;
var rtThreshold = rtPercentiles['fiftieth'];
var currentPoints = 0;
var error = 0;
var timeout = 0;
var chosenDeckLocation = '';
var selectionKey = 0;
var condition = '';
var trialStruct = new Array();
var blockStruct = new Array();
var startTime = new Date();
var cuedRt = new Date();
var choiceRt = new Date();
var blockTime = new Date();
var phaseStartTime = new Date();


var vid = document.getElementById('tutorial');

// serve client facing controls string
var controlsString = '<p>The blue task is: ' + clientCueCode['blue'] + (clientCueCode['blue'] == 'Magnitude'? ' (j: low, k: high)': ' (j: odd, k: even)') +'</p><p>The red task is: ' + clientCueCode['red'] + (clientCueCode['red'] == 'Magnitude'? ' (j: low, k: high)' : ' (j: odd, k: even)') +'</p>';

// set initial state
$('#detailSlide').hide();
$('#controlsFill').html(controlsString);
$('#keyRemindSlide').hide();
$('.expSlide').hide();
$('#blockTransitionSlide').hide();


$('#detail').click(function(){
  $('#titleSlide').hide();
  $('#detailSlide').show();
  vid.pause();
});

$('.resetTitle').click(function() {
  $('#titleSlide').show();
  $('#detailSlide').hide();
  $('#keyRemindSlide').hide();
});

$('#seeKeys').click(function(){
  $('#keyRemindSlide').show();
  $('#titleSlide').hide();
  vid.pause();
});

$('#startSegment').click(function(){
  startSegment();
});

function startSegment() {
  $('#keyRemindSlide').hide();

  $('#keyToggle').html(controlsString);
  $('#keyToggle').hide();
  $('.card').addClass('cardHidden');
  
  blockTransition();

} // end startSegment()

function blockTransition() {

  // update block time
  blockTime = (new Date() - blockTime) / 1000;

  // refresh global vars
  blockCount += 1;
  currentPoints = 0;
  trialCount = 0;
  prevTaskColor = '';
  var additionalInstructions = '';
  var feedback = '';

  if (blockCount == 1){
    additionalInstructions = '<p>From this point on, segments of the HIT are broken up into groups. Each group lasts until you have reached ' + String(pointThreshold) + ' points. The points you currently have and the amount of points you need in order to finish the group will be displayed on the screen while you\'re performing the group.</p><br>'
  } else {
    
    blockStruct.push({
      'block': blockCount - 1,
      'blockTime': blockTime,
      'trialStruct': trialStruct
    });
    
    feedback = '<p>You completed that last group in ' + String(Math.round(blockTime)) + ' seconds. Remember, the faster you finish each group, the faster the whole HIT is over.</p><br>';
  }

  trialStruct = new Array();

  // need a method for saving block data here

  // control display
  $('.expSlide').hide();
  $('#' + chosenDeckLocation + 'Card').removeClass('cardShow').addClass('cardHidden');
  
  if (blockCount <= blockThreshold) {
    $('#blockInstructions').html(additionalInstructions + feedback + '<p>You are in Segment 4 of the HIT and are about to perform Group ' + String(blockCount) + ' of ' + String(blockThreshold) + '. Please press "Continue" when you are ready to start this group.</p>');
    $('#blockTransitionSlide').show();
    $('#startBlock').unbind().click(function(){
      blockTime = new Date();
      $('#blockTransitionSlide').hide();
      $('.expSlide').show();
      runTrial();
    });

  } else {
    endSegment();
  }
  
}


function runTrial() {
  
  // update count
  trialCount += 1;

  //control display
  $('.bottomHalf').hide();
  $('.cardStim').hide();
  // if it's not the first trial, hide the recently active card
  if (trialCount > 1) {
    $('#' + chosenDeckLocation + 'Card').removeClass('cardShow').addClass('cardHidden');
  }

  // update points feedback
  $('.bonusFeedback').html('<p>Points: ' + numberWithCommas(Math.round(currentPoints)) + ' / ' + numberWithCommas(pointThreshold));
  $('.bonusFeedback').show();

  // get the condition
  condition = getCondition('twoChoice');

  // determine deck attributes (switch levels and location)
  deckCode = getDeckCode(2, 'twoChoice', condition, highRewardPoints);

  // update deck attributes
  $('#leftDeckSwitch').html('<p>' + Math.round(deckCode['left']['pSwitch'] * 100) + '%</p>');
  $('#rightDeckSwitch').html('<p>' + Math.round(deckCode['right']['pSwitch'] * 100) + '%</p>');
  $('#leftDeckPoints').html('<p>' + Math.round(deckCode['left']['points']) + '</p>');
  $('#rightDeckPoints').html('<p>' + Math.round(deckCode['right']['points']) + '</p>');

  // control rsi, initialize stimulus
  setTimeout(function(){
    $('.bottomHalf').show();

    // start choice rt timer
    startTime = new Date();

    // listen for space bar
    $(document).bind('keydown.listenForSpaceDown', function(e){
      if (e.which == 32) {
        $('#keyToggle').show();
      }
    });
    $(document).bind('keyup.listenForSpaceUp', function(e){
      if (e.which == 32) {
        $('#keyToggle').hide();
      }
    });

    // listen for choice keys
    $(document).bind('keydown.listenForChoiceKeys', function(e){

      if ($.inArray(e.which, [68, 70]) + 1){

        // record choice rt
        choiceRt = new Date() - startTime;

        selectionKey = e.which;
        // get the location of the chosen deck as 'left' or 'right'
        chosenDeckLocation = getChosenDeckLocation(selectionKey, phase);

        // stop listening for keys
        $(document).unbind('keydown.listenForChoiceKeys');

        // reset response count
        responseCount = 0;

        cuedTrial();

      }

    }); // end listen for choice keys

  }, rsi);

} // end runTrial()


function cuedTrial() {

  // generate stimulus
  currentTaskColor = generateTransition(deckCode[chosenDeckLocation]['pSwitch'], prevTaskColor);
  currentStim = generateCuedStim();
  currentTask = taskCueCode[currentTaskColor];

  // code transition var for data storage
  if (prevTaskColor) {
    transition = currentTaskColor == prevTaskColor? 'repeat' : 'switch';
  } else {
    transition = 'startBlock';
  }

  // update display
  // hide from previous trial
  $('#' + chosenDeckLocation + 'Card').removeClass('cardShow').addClass('cardHidden');
  $('.cardStim').hide();
  $('#' + chosenDeckLocation + 'CardFeedback').hide();
  // update with new information
  $('#' + chosenDeckLocation + 'CardStim').html('<p>' + currentStim + '</p>');
  $('#' + chosenDeckLocation + 'CardStim').css({'color': currentTaskColor});
  $('.bonusFeedback').html('<p>Points: ' + numberWithCommas(Math.round(currentPoints)) + ' / ' + numberWithCommas(pointThreshold));

  // reset error and timeout
  error = 0;
  timeout = 0;


  // initialize cued stimulus, control cued rsi
  setTimeout(function(){

    // show card from chosen deck
    $('#' + chosenDeckLocation + 'Card').addClass('cardShow').removeClass('cardHidden');
    $('.cardStim').show();

    // start cued rt timer
    startTime = new Date();

    // rtWindow procedure
    rtWindow = setTimeout(function(){
      // stop listening for response keys
      $(document).unbind('keydown.listenForResponseKeys');

      // set cued rt to dummy value
      cuedRt = -999;

      // update timeout var
      timeout = 1;

      //fill and show feedback
      $('#' + chosenDeckLocation + 'CardFeedback').html('<p><strong>TIMEOUT!</strong></p>');
      $('#' + chosenDeckLocation + 'CardFeedback').show();

      // update vars
      responseCount += 1;
      prevTaskColor = currentTaskColor;

      //record data
      saveTrialData();

      // prepare for next trial
      setTimeout(function(){
        $('#' + chosenDeckLocation + 'CardFeedback').hide();
        if (currentPoints < pointThreshold) {
          if (responseCount == 2) {
            runTrial();
          } else {
            cuedTrial();
          }
        } else {
          if (responseCount == 2) {
            blockTransition();
          } else {
            cuedTrial();
          }
        }
      }, rsi); // end timeout rsi

    }, rtThreshold) // end rtWindow
    
    // start listening for keys
    $(document).bind('keydown.listenForResponseKeys', function(i){
      // if response key is one of the valid keys
      if ($.inArray(i.which, [74, 75]) + 1) {
        
        // record cued rt
        cuedRt = new Date() - startTime;

        //stop listening for keys
        $(document).unbind('keydown.listenForResponseKeys');
        // stop timeout procedure
        clearTimeout(rtWindow);
        // code error
        error = cuedIsError(String(i.which), currentTask, currentStim);
        // code transition
        transition = codeTransition(prevTaskColor, currentTaskColor);
        // update response count
        responseCount += 1;
        // update previous task color
        prevTaskColor = currentTaskColor;

        //record data
        saveTrialData();

        // start error sequence
        if (error) {
          // fill and display feedback
          $('#' + chosenDeckLocation + 'CardFeedback').html('<p><strong>ERROR!</strong></p>');
          $('#' + chosenDeckLocation + 'CardFeedback').show();
          // prepare for next trial
          setTimeout(function(){
            $('#' + chosenDeckLocation + 'CardFeedback').hide();  
            
            if (responseCount == 2) {
              runTrial();
            } else {
              cuedTrial();
            }
          
          }, rsi)

        // if accurate response
        } else { 

          currentPoints = currentPoints + (deckCode[chosenDeckLocation]['points'] / 2);

          if (currentPoints < pointThreshold) {
            if (responseCount == 2) {
              runTrial();
            } else {
              cuedTrial();
          }
        } else {
            blockTransition();
          }
        }

      } // end is response valid?

    }); //end listen for keys

  }, rsi); // end cued rsi


} // end cuedTrial()

function saveTrialData() {
  trialStruct.push({
    'block': blockCount,
    'trial': trialCount,
    'experimentRunTimeMins': Math.round((Date.now() - experimentStartTime) / 1000 / 60),
    'phaseRunTimeMins': Math.round((Date.now() - phaseStartTime) / 1000 / 60),
    'responseCount': responseCount,
    'rsi': rsi,
    'rtThreshold': rtThreshold,
    'stimulus': currentStim,
    'stimColor': currentTaskColor,
    'task': currentTask,
    'condition': condition,
    'transition': transition,
    'highRewardPoints': highRewardPoints,
    'leftDeckId': deckCode['left']['id'],
    'leftDeckPoints': Math.round(deckCode['left']['points']),
    'leftDeckSwitch': Math.round(deckCode['left']['pSwitch'] * 100),
    'rightDeckId': deckCode['right']['id'],
    'rightDeckPoints': Math.round(deckCode['right']['points']),
    'rightDeckSwitch': Math.round(deckCode['right']['pSwitch'] * 100),
    'chosenDeckLocation': chosenDeckLocation,
    'currentPoints': Math.round(currentPoints),
    'error': error,
    'timeout': timeout,
    'choiceCode': deckCode[chosenDeckLocation]['id'],
    'choiceRt': choiceRt,
    'cuedRt': cuedRt
  });
}

function endSegment() {

  var curDate = new Date();
  var finishTime = new Date() - phaseStartTime;
  var curId = (IsOnTurk())?  GetAssignmentId() : prompt("Doesn't look like you are on Turk, so I'm guessing you're probably testing. Enter an ID to save your data with.", "id");

  var currentData = {
    'curId': curId,
    'workerId': GetWorkerId(),
    'curTime': curDate.today() + '@' + curDate.timeNow(),
    'userAgent': navigator.userAgent,
    'screenWidth': screen.width,
    'screenHeight': screen.height,
    'windowWidth': $(window).width(),
    'windowHeight': $(window).height(),
    'phase': phase,
    'blueTask': taskCueCode['blue'],
    'redTask': taskCueCode['red'],
    'twoChoiceRunTime': finishTime,
    'blockStruct': blockStruct
  };

  sendToServer(curId, currentData);

}

function sendToServer(curId, currentData) {

  var dataToServer = {
    'curId': curId,
    'experiment': experimentName,
    'sessionCode': phase,
    'currentData': JSON.stringify(currentData)
  };

  var urlArgs = {
    'workerId': GetWorkerId(),
    'assignmentId': GetAssignmentId(),
    'taskCueCode': taskCueCode,
    'experimentStartTime': experimentStartTime,
    'rtPercentiles': rtPercentiles,
    'highRewardPoints': highRewardPoints
  };

  $.post(
    url = '../../../../cgi-bin/saveData.py',
    data = dataToServer,
    success = function(data) {
      window.location.replace('../threeChoice/?' + $.param(urlArgs));
    }).fail(function(data){
      console.log('FAILURE');
      window.location.replace('../threeChoice/?' + $.param(urlArgs));
    });

}

}); // end document.ready()

</script>

</head>

<body>

<!-- the entire display -->
<div class='container'>
  <!-- the 800 x 600 experiment area -->
  <div class='screen'>

    <!-- BEGIN TITLE SLIDE -->
      <div id='titleSlide'>
        <div class='titleBar'>
          <h2>Welcome to the fourth phase.</h2>
          <p>You are now ready to begin the main experiment.</p>
        </div>

        <div class='leftTwoThirds'>
          <p>That is it for the practice. Watch the video to get some basics about how the rest of the experiment will run.</p>
          <p class='small'>If you'd rather see text instructions, click the "See Text Instructions" button to the right.</p>


          <video id = 'tutorial' width = "460" height = "240" controls>
            <source src = "twoChoiceTutorial.mp4" type = "video/mp4">
          </video>
        </div>

        <div class='rightOneThirdsDown'>
          <button id='detail' class='experimentButton center smallButton'>See Text Instructions</button>
          <button id='seeKeys' class='experimentButton center'>See Controls</button>
        </div>
      </div> <!-- end title slide -->

    <!-- BEGIN DETAIL SLIDE -->
    <div id='detailSlide'>
      <p>Placeholder.</p>
      <button class='experimentButton resetTitle'>Go Back</button>
    </div> <!-- end detail slide -->


    <!-- BLOCK TRANSITION SLIDE -->
    <div id='blockTransitionSlide'>
      <div class='titleBar'>
      </div>

      <div class='leftTwoThirds' id='blockInstructions'>
      </div>

      <div class='rightOneThirdsDown'>
        <button class='experimentButton center' id='startBlock'>Continue</button>
      </div>
    </div> <!-- end block transition slide -->

    <!-- KEY REMIND SLIDE -->
    <div id='keyRemindSlide'>
      <div class='titleBar'>
        <p>Here are your controls. Remember, you can see this information at any point by holding down the space bar.</p>
      </div>

      <div class='leftTwoThirds' id='controlsFill'>
      </div>

      <div class='rightOneThirdsDown'>
        <button class='resetTitle experimentButton smallButton center'>Go Back</button>
        <button id='startSegment' class='experimentButton center'>Begin Segment</button>
      </div>
    </div> <!-- end key remind slide -->

    <div class='expSlide'>
      <div class='feedbackContainer'>
        <div class='feedbackLevelOne'>
          <div class='bonusFeedback'>
          </div>
        </div>

        <div class='feedbackLevelTwo'>
          <div id='keyToggle' class='keyFormat'>
          </div>
        </div>

      </div>
      

      <div class='topHalf'>
        <div class='card' id='leftCard'>
          <div class='cardFeedback' id='leftCardFeedback'>
          </div>
          <div class='cardStim' id='leftCardStim'>
          </div>
        </div>
        <!--
        <div class='card' id='middleCard'>
          <div class='cardFeedback' id='middleCardFeedback'>
          </div>          
          <div class='cardStim' id='middleCardStim'>
          </div>
        </div>
        -->
        <div class='card' id='rightCard'>
          <div class='cardFeedback' id='rightCardFeedback'>
          </div>          
          <div class='cardStim' id='rightCardStim'>
          </div>
        </div>        
      
      </div> <!-- end top half -->

      <div class='bottomHalf'>
        <div class='deck' id='leftDeck'>
          <div class='deckAttribute' id='leftDeckPoints'>
          </div>
          <div class='deckAttribute' id='leftDeckSwitch'>
          </div>
        </div>
        <!--<div class='deck' id='middleDeck'>
          <div class='deckAttribute' id='middleDeckPoints'>
          </div>
          <div class='deckAttribute' id='middleDeckSwitch'>
          </div>          
        </div>-->
        <div class='deck' id='rightDeck'>
          <div class='deckAttribute' id='rightDeckPoints'>
          </div>
          <div class='deckAttribute' id='rightDeckSwitch'>
          </div>          
        </div>
      </div> <!-- end bottom half -->


    </div> <!-- end expSlide -->



  </div> <!-- end screen -->

</div> <!-- end container -->