<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
  <title>Braun Dissertation</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link rel='stylesheet' type='text/css' href='../css/exp1Style.css'>
  <link rel='stylesheet' type='text/css' href='../../globalStyle/globalStyle.css?v=2'>
  <link rel='stylesheet' type='text/css' href='../../globalStyle/deckStyle.css'>
  <script src='../js/exp1Functions.js?v=6'></script>
  <script src='../../globalJs/globalFunctions.js?v=11'></script>
  <script src='../../globalJs/TimTurkTools.js'></script>
  <script src='../../globalJs/jquery-bbq.js'></script>

<script>

$(document).ready(function(){

// global vars
// parse url args
var taskCueCode = urlArgsToVar('taskCueCode')=='NONE'? codeTaskCue() : urlArgsToVar('taskCueCode');
var clientCueCode = cueForClient(taskCueCode);
var experimentStartTime = urlArgsToVar('experimentStartTime');
// THE VALUES COME IN AS STRINGS (for now)
var rtPercentiles = urlArgsToVar('rtPercentiles');
rtPercentiles['fiftieth'] = parseInt(rtPercentiles['fiftieth'])
rtPercentiles['thirtyFifth'] = parseInt(rtPercentiles['thirtyFifth'])

console.log(['experiment start time: ', experimentStartTime]);

// other global vars
var trialCount = 0;
var rsi = 500;
var prevTaskColor = '';
var rtStartTime = new Date();
var responseCount = 0;
var trialThreshold = 10;
var rtThreshold = rtPercentiles['fiftieth'];
var currentPoints = 0;
var pointThreshold = 1400;
var error = 0;
var chosenDeckLocation = '';
var selectionKey = 0;

// for calibration
var pointCalibration = {
  lowRewardPoints: 50,
  highRewardPoints: 75,
  currentAdjustment: 12.5,
  prevDeckDifficulty: ''
}

var vid = document.getElementById('tutorial');

// set initial state
$('#detailSlide').hide();
$('#keyRemindSlide').hide();
$('.expSlide').hide();


$('#detail').click(function(){
  $('#titleSlide').hide();
  $('#detailSlide').show();
  vid.pause();
});

$('.resetTitle').click(function() {
  $('#titleSlide').show();
  $('#detailSlide').hide();
  $('#keyRemindSlide').hide();
});

$('#seeKeys').click(function(){
  $('#keyRemindSlide').show();
  $('#titleSlide').hide();
  vid.pause();
});

$('#startSegment').click(function(){
  startSegment();
});

function startSegment() {
  $('#keyRemindSlide').hide();

  $('#keyToggle').html('<p>The blue task is: ' + clientCueCode['blue'] + (clientCueCode['blue'] == 'Magnitude'? ' (j: low, k: high)': ' (j: odd, k: even)') +'</p><p>The red task is: ' + clientCueCode['red'] + (clientCueCode['red'] == 'Magnitude'? ' (j: low, k: high)' : ' (j: odd, k: even)') +'</p>');
  $('#keyToggle').hide();
  $('.card').addClass('cardHidden');
  $('.expSlide').show();


  runTrial();

} // end startSegment()


function runTrial() {
  // update count
  trialCount += 1;

  //control display
  $('.bottomHalf').hide();
  $('.cardStim').hide();
  // if it's not the first trial, hide the recently active card
  if (trialCount > 1) {
    $('#' + chosenDeckLocation + 'Card').removeClass('cardShow').addClass('cardHidden');
  }

  // update points feedback
  $('.bonusFeedback').html('<p>Points: ' + numberWithCommas(Math.round(currentPoints)) + ' / ' + numberWithCommas(pointThreshold));
  $('.bonusFeedback').show();

  // determine deck attributes (switch levels and location)
  deckCode = getDeckCode(2, 'prac', '', 0);

  // determine deck points
  [deckCode, pointCalibration] = calibrateDeckPoints(deckCode, pointCalibration, trialCount);

  // update deck attributes
  $('#leftDeckSwitch').html('<p>' + deckCode['left']['pSwitch'] * 100 + '%</p>');
  $('#rightDeckSwitch').html('<p>' + deckCode['right']['pSwitch'] * 100 + '%</p>');
  $('#leftDeckPoints').html('<p>' + Math.round(deckCode['left']['points']) + '</p>');
  $('#rightDeckPoints').html('<p>' + Math.round(deckCode['right']['points']) + '</p>');

  // control rsi, initialize stimulus
  setTimeout(function(){
    $('.bottomHalf').show();

    // listen for space bar
    $(document).bind('keydown.listenForSpaceDown', function(e){
      if (e.which == 32) {
        $('#keyToggle').show();
      }
    });
    $(document).bind('keyup.listenForSpaceUp', function(e){
      if (e.which == 32) {
        $('#keyToggle').hide();
      }
    });

    // listen for choice keys
    $(document).bind('keydown.listenForChoiceKeys', function(e){

      if ($.inArray(e.which, [68, 70]) + 1){

        selectionKey = e.which;
        // get the location of the chosen deck as 'left' or 'right'
        chosenDeckLocation = getChosenDeckLocation(selectionKey, 'twoChoice');

        // stop listening for keys
        $(document).unbind('keydown.listenForChoiceKeys');

        // reset response count
        responseCount = 0;

        cuedTrial();

      }

    }); // end listen for choice keys

  }, rsi);

} // end runTrial()


function cuedTrial() {

  console.log([deckCode, chosenDeckLocation]);

  // generate stimulus
  currentTaskColor = generateTransition(deckCode[chosenDeckLocation]['pSwitch'], prevTaskColor);
  currentStim = generateCuedStim();
  currentTask = taskCueCode[currentTaskColor];

  // update display
  $('#' + chosenDeckLocation + 'Card').removeClass('cardShow').addClass('cardHidden');
  $('.cardStim').hide();
  $('#' + chosenDeckLocation + 'CardFeedback').hide();
  $('#' + chosenDeckLocation + 'CardStim').html('<p>' + currentStim + '</p>');
  $('#' + chosenDeckLocation + 'CardStim').css({'color': currentTaskColor});
  //update points
  $('.bonusFeedback').html('<p>Points: ' + numberWithCommas(Math.round(currentPoints)) + ' / ' + numberWithCommas(pointThreshold));

  // reset error 
  error = 0;

  // initialize cued stimulus, control cued rsi
  setTimeout(function(){

    // show card from chosen deck
    $('#' + chosenDeckLocation + 'Card').addClass('cardShow').removeClass('cardHidden');
    $('.cardStim').show();

    rtWindow = setTimeout(function(){
      // stop listening for response keys
      $(document).unbind('keydown.listenForResponseKeys');

      //fill and show feedback
      $('#' + chosenDeckLocation + 'CardFeedback').html('<p><strong>TIMEOUT!</strong></p>');
      $('#' + chosenDeckLocation + 'CardFeedback').show();

      // update vars
      responseCount += 1;
      prevTaskColor = currentTaskColor;
      pointCalibration['prevDeckDifficulty'] = deckCode[chosenDeckLocation]['id'];
      console.log('from main script');
      console.log([pointCalibration, deckCode, chosenDeckLocation]);

      // prepare for next trial
      setTimeout(function(){
        $('#' + chosenDeckLocation + 'CardFeedback').hide();
        if (trialCount != trialThreshold) {
          if (responseCount == 2) {
            runTrial();
          } else {
            cuedTrial();
          }
        } else {
          if (responseCount == 2) {
            endSegment();
          } else {
            cuedTrial();
          }
        }
      }, rsi); // end timeout rsi

    }, rtThreshold) // end rtWindow
    

    $(document).bind('keydown.listenForResponseKeys', function(i){
      if ($.inArray(i.which, [74, 75]) + 1) {
        //stop listening for keys
        $(document).unbind('keydown.listenForResponseKeys');
        // stop timeout procedure
        clearTimeout(rtWindow);
        // code error
        error = cuedIsError(String(i.which), currentTask, currentStim);
        // code transition
        transition = codeTransition(prevTaskColor, currentTaskColor);
        // update response count
        responseCount += 1;
        // update previous task color
        prevTaskColor = currentTaskColor;
        // update previous task difficulty
        pointCalibration['prevDeckDifficulty'] = deckCode[chosenDeckLocation]['id'];
        console.log('from main script');
        console.log([pointCalibration, deckCode, chosenDeckLocation]);

        // start error sequence
        if (error) {
          // fill and display feedback
          $('#' + chosenDeckLocation + 'CardFeedback').html('<p><strong>ERROR!</strong></p>');
          $('#' + chosenDeckLocation + 'CardFeedback').show();
          // prepare for next trial
          setTimeout(function(){
            $('#' + chosenDeckLocation + 'CardFeedback').hide();
            if (trialCount != trialThreshold) {
              if (responseCount == 2) {
                runTrial();
              } else {
                console.log('Error sequence is running');
                cuedTrial();
              }
            } else {
              if (responseCount == 2) {
                endSegment();
              } else {
                cuedTrial();
                }
              }
          }, rsi)

        // if accurate response
        } else { 

          currentPoints = currentPoints + (deckCode[chosenDeckLocation]['points'] / 2);

          if (trialCount != trialThreshold) {
            if (responseCount == 2) {
              runTrial();
            } else {
              cuedTrial();
          }
        } else {
          if (responseCount == 2) {
            endSegment();
          } else {
            cuedTrial();
            }
          }
        }

      } // end is response valid?

    }); //end listen for keys

  }, rsi); // end cued rsi


} // end cuedTrial()

function endSegment() {
  console.log('ayy we done mf lmao');
  urlArgs = {
    'workerId': GetWorkerId(),
    'assignmentId': GetAssignmentId(),
    'taskCueCode': taskCueCode,
    'experimentStartTime': experimentStartTime,
    'rtPercentiles': rtPercentiles,
    'highRewardPoints': pointCalibration['highRewardPoints']
  };

  window.location.replace('../twoChoice/?' + $.param(urlArgs));
}

}); // end document.ready()

</script>

</head>

<body>

<!-- the entire display -->
<div class='container'>
  <!-- the 800 x 600 experiment area -->
  <div class='screen'>

    <!-- BEGIN TITLE SLIDE -->
      <div id='titleSlide'>
        <div class='titleBar'>
          <h2>Welcome to the third segment.</h2>
          <p>You will now be introduced to the reward system.</p>
        </div>

        <div class='leftTwoThirds'>
          <p>Now that you are familiar with how to choose between decks, we'll add reward to the decks. The goal is to earn a set amount of points as quickly as possible, and different decks will give you different amounts of points. Watch the video for full instructions.</p>
          <p class='small'>If you'd rather see text instructions, click the "See Text Instructions" button to the right.</p>


          <video id = 'tutorial' width = "410" height = "190" controls>
            <source src = "../placeholder.mp4" type = "video/mp4">
          </video>
        </div>

        <div class='rightOneThirdsDown'>
          <button id='detail' class='experimentButton center smallButton'>See Text Instructions</button>
          <button id='seeKeys' class='experimentButton center'>See Controls</button>
        </div>
      </div> <!-- end title slide -->

    <!-- BEGIN DETAIL SLIDE -->
    <div id='detailSlide'>
      <p>Placeholder.</p>
      <button class='experimentButton resetTitle'>Go Back</button>
    </div> <!-- end detail slide -->


    <!-- KEY REMIND SLIDE -->
    <div id='keyRemindSlide'>
      <div class='titleBar'>
      </div>

      <div class='leftTwoThirds'>
        <p>Blah blah blah keys and what naht.</p>
      </div>

      <div class='rightOneThirdsDown'>
        <button class='resetTitle experimentButton smallButton center'>Go Back</button>
        <button id='startSegment' class='experimentButton center'>Begin Segment</button>
      </div>
    </div> <!-- end key remind slide -->

    <div class='expSlide'>
      <div class='feedbackContainer'>
        <div class='feedbackLevelOne'>
          <div class='bonusFeedback'>
          </div>
        </div>

        <div class='feedbackLevelTwo'>
          <div id='keyToggle' class='keyFormat'>
          </div>
        </div>

      </div>
      

      <div class='topHalf'>
        <div class='card' id='leftCard'>
          <div class='cardFeedback' id='leftCardFeedback'>
          </div>
          <div class='cardStim' id='leftCardStim'>
          </div>
        </div>
        <!--
        <div class='card' id='middleCard'>
          <div class='cardFeedback' id='middleCardFeedback'>
          </div>          
          <div class='cardStim' id='middleCardStim'>
          </div>
        </div>
        -->
        <div class='card' id='rightCard'>
          <div class='cardFeedback' id='rightCardFeedback'>
          </div>          
          <div class='cardStim' id='rightCardStim'>
          </div>
        </div>        
      
      </div> <!-- end top half -->

      <div class='bottomHalf'>
        <div class='deck' id='leftDeck'>
          <div class='deckAttribute' id='leftDeckPoints'>
          </div>
          <div class='deckAttribute' id='leftDeckSwitch'>
          </div>
        </div>
        <!--<div class='deck' id='middleDeck'>
          <div class='deckAttribute' id='middleDeckPoints'>
          </div>
          <div class='deckAttribute' id='middleDeckSwitch'>
          </div>          
        </div>-->
        <div class='deck' id='rightDeck'>
          <div class='deckAttribute' id='rightDeckPoints'>
          </div>
          <div class='deckAttribute' id='rightDeckSwitch'>
          </div>          
        </div>
      </div> <!-- end bottom half -->


    </div> <!-- end expSlide -->



  </div> <!-- end screen -->

</div> <!-- end container -->