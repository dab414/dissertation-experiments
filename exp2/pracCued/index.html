<!DOCTYPE html>
<html lang = 'en'>
<head>
  <meta charset='UTF-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
  <title>Braun Dissertation</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link rel='stylesheet' type='text/css' href='../../globalStyle/globalStyle.css?v=4'>
  <link rel='stylesheet' type='text/css' href='../style/exp2Style.css'>
  <script src='../js/exp2Functions.js'></script>
  <script src='../../globalJs/globalFunctions.js'></script>
  <script src='../../globalJs/TimTurkTools.js'></script>

  <script>

$(document).ready(function(){
  // global vars
  var transition = 'startBlock';
  var taskCueCode = createTaskCue();
  var clientCueCode = createClientCueText(taskCueCode);
  var transitionArray = [];
  var currentTaskColor = '';
  var currentTask = '';
  var error = 0;
  var currentStim = '';
  var trialCount = 0;
  var trialStruct = new Array();
  var rt = 0;
  var keyCode = {74: 'j', 75: 'k'}
  var prevTaskColor = '';
  var experimentName = 'dissertationExperiment1';
  var phase = 'pracCued';
  // experimentStartTime in MS
  var experimentStartTime = Date.now();
  var rtStartTime = new Date();

  // thresholds & manipulations
  // DEVELOPMENT
  var trialThreshold = 17;
  var rsi = 500;
  var errorTimeout = 500;
  var cycleThreshold = 3;
  var cycleCount = 0;
  var notFirstRun = 0;

  // string for serving client key reminders
  var controlsString = '<p>The blue task is: ' + clientCueCode['blue'] + (clientCueCode['blue'] == 'Magnitude'? ' (j: low, k: high)': ' (j: odd, k: even)') +'</p><p>The red task is: ' + clientCueCode['red'] + (clientCueCode['red'] == 'Magnitude'? ' (j: low, k: high)' : ' (j: odd, k: even)') +'</p>';

  // save an init
  registerId(experimentName);

  // control flow of first few clicks
  $('#titleSlide').show();
  $('#detailSlide').hide();
  $('#controlsFill').html(controlsString);
  $('#keyRemindSlide').hide();
  $('.stimSlide').hide();
  $('.interCycleSlide').hide();

  // DEVELOPMENT -- update
  // var vid = document.getElementById('tutorial');

  $('#detail').click(function(){
    $('#titleSlide').hide();
    $('#detailSlide').show();
    vid.pause();
  });

  $('.resetTitle').click(function(){
    $('#titleSlide').show();
    $('#detailSlide').hide();
    $('#keyRemindSlide').hide();
  });

  $('#seeKeys').click(function(){
    $('#keyRemindSlide').show();
    $('#titleSlide').hide();
    vid.pause();
  });

  $('#startCued').click(function(){
    startCued();
  });


function startCued() {
  // set initial state

  $('#keyRemindSlide').hide();
  $('.keyContainer').html(controlsString);
  $('.keyContainer').hide();
  $('.errorContainer').hide();
  runCycle();
}

function runCycle() {
  $('.stimSlide').hide();
  
  if (cycleCount == cycleThreshold) {
    endCued();
  } else {
    transitionArray = generateTransitionArray(8);
    cycleCount += 1;
    trialCount = 0;
    if (notFirstRun) {
      $('.interCycleSlide').show();
      setTimeout(function(){
        $('.interCycleSlide').hide();
        $('.stimSlide').show()
        runTrial();
      }, 5000)
    } else {
      notFirstRun = 1;
      $('.stimSlide').show()
      runTrial();
    }
  }
}

function runTrial() {
  // update count
  trialCount += 1;

  // generate stimulus
  $('.stimContainer').hide();
  currentTaskColor = transitionArray[trialCount - 1];
  currentStim = generateCuedStim();
  currentTask = taskCueCode[currentTaskColor];
  $('.stimContainer').html('<p>' + currentStim + '</p>');
  $('.stimContainer').css({'color': currentTaskColor});

  // trigger RSI
  setTimeout(function(){

    // show stimulus
    $('.stimContainer').show();

    // start rt clock
    rtStartTime = new Date();

    // reset error 
    error = 0;

    // listen for space bar
    $(document).bind('keydown.listenForSpaceDown', function(e){
      if (e.which == 32) {
        $('.keyContainer').show();
      }
    });
    $(document).bind('keyup.listenForSpaceUp', function(e){
      if (e.which == 32) {
        $('.keyContainer').hide();
      }
    });

    // listen for response keys 
    $(document).bind('keydown.listenForKeys', function(e){
      if ($.inArray(e.which, [74, 75]) + 1) {
        
        // log rt
        rt = new Date() - rtStartTime;

        // stop listening for response keys
        $(document).unbind('keydown.listenForKeys');

        // code error
        error = cuedIsError(String(e.which), currentTask, currentStim);
        
        // code transition
        transition = codeTransition(prevTaskColor, currentTaskColor);

        // log data
        trialStruct.push({
          'trialCount': trialCount,
          'rsi': rsi,
          'runTimeMins': Math.round((Date.now() - experimentStartTime) / 1000 / 60),
          'stimulus': currentStim,
          'stimColor': currentTaskColor,
          'taskCode': currentTask,
          'responseKey': keyCode[e.which],
          'transition': transition,
          'error': error,
          'rt': rt
        });


        // update prevTaskColor
        prevTaskColor = currentTaskColor;

        // prepare for next trial
        if (error) {
          $('.errorContainer').show();

          setTimeout(function(){
            if (trialCount == trialThreshold) {
              $('.errorContainer').hide();
              runCycle();
            } else {
              $('.errorContainer').hide();
              runTrial();
            }
          }, errorTimeout)
        } else {
          if (trialCount == trialThreshold) {
            runCycle();
          } else {
            runTrial();
          }
        }

      }
    });

  }, rsi);


}

function endCued() {
  // store and send cued data and ship to next phase
  var curDate = new Date();
  var finishTime = new Date() - experimentStartTime;
  var curId = (IsOnTurk())? GetAssignmentId() : prompt("Doesn't look like you are on Turk, so I'm guessing you're probably testing." + 
    " Enter an ID to save your data with:", "id");

  var currentData = {
    'curId': curId,
    'workerId': GetWorkerId(),
    'curTime': curDate.today() + '@' + curDate.timeNow(),
    'userAgent': navigator.userAgent,
    'screenWidth': screen.width,
    'screenHeight': screen.height,
    'windowWidth': $(window).width(),
    'windowHeight': $(window).height(),
    'phase': phase,
    'blueTask': taskCueCode['blue'],
    'redTask': taskCueCode['red'],
    'cuedRunTime': finishTime,
    'trialStruct': trialStruct
  }


  sendToServer(curId, currentData);
}

function sendToServer(curId, currentData) {
  var dataToServer = {
    'curId': curId,
    'experiment': experimentName,
    'sessionCode': phase,
    'currentData': JSON.stringify(currentData)
  };

  var urlArgs = {
    'workerId': GetWorkerId(),
    'assignmentId': GetAssignmentId(),
    'taskCueCode': taskCueCode,
    'experimentStartTime':  experimentStartTime
  };

  $.post(
    // relative to this script
    url = '../../../../../cgi-bin/saveData.py',
    data = dataToServer,
    success = function(data) {
      window.location.replace('../dst/?' + $.param(urlArgs));
    }).fail(function(data){
      console.log('FAILURE');
      window.location.replace('../dst/?' + $.param(urlArgs));
    });

}


}); // end documnet.ready()

  </script>


</head>

<body>

  <!-- the entire display -->
  <div class='container'>
    <!-- the 800 x 600 experiment area -->
    <div class='screen'>

      <!-- BEGIN TITLE SLIDE -->
      <div id='titleSlide'>
        <div class='titleBar'>
          <h2>Welcome to the HIT.</h2>
          <p>You will be making simple responses to prompts on the screen. The HIT should last for about 30 mins.</p>
        </div>

        <div class='leftTwoThirds'>
          <p>Instructions pending.</p>

          <!-- Need to update
          <video id = 'tutorial' width = "460" height = "240" controls>
            <source src = "pracCuedTutorial.mp4" type = "video/mp4">
          </video>
        -->
        </div>

        <div class='rightOneThirdsDown'>
          <button id='detail' class='experimentButton center smallButton'>See Text Instructions</button>
          <button id='seeKeys' class='experimentButton center'>See Controls</button>
        </div>
      </div> <!-- end title slide -->


    <!-- BEGIN DETAIL SLIDE -->
    <div id='detailSlide'>
      <p>Placeholder.</p>
      <button class='experimentButton resetTitle'>Go Back</button>
    </div> <!-- end detail slide -->

    <div class='interCycleSlide'>
      <p>That was the end of that 17-trial cycle, the next one will begin shortly. Remember 8 of the 16 trial transitions will be task switches, and that is the difficulty level that can be expected during these types of tasks.</p>
    </div>

    <!-- KEY REMIND SLIDE -->
    <div id='keyRemindSlide'>
      <div class='titleBar'>
        <p>Here are your controls. Remember, you can see this information at any point by holding down the space bar.</p>
      </div>

      <div class='leftTwoThirds' id='controlsFill'>
      </div>

      <div class='rightOneThirdsDown'>
        <button class='resetTitle experimentButton smallButton center'>Go Back</button>
        <button id='startCued' class='experimentButton center'>Begin Segment</button>
      </div>
    </div> <!-- end key remind slide -->

    <!-- STIMULUS SLIDE -->
    <!-- a centered column div serving as the parent flex-box -->
    <div class='stimSlide'>
      <!-- html filled from js -->
      <div class='keyContainer'>
      </div>

      <div class='errorContainer'>
        <p><strong>ERROR!</strong></p>
      </div>

      <div class='stimContainer'>
      </div>
    </div> <!-- end stimWrapper -->



    </div> <!-- end screen -->
  </div> <!-- end container-->

</body>

</html>